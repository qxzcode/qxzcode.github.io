"use strict";var canvas=document.querySelector("canvas"),ctx=canvas.getContext("2d");function stop(){clearInterval(window.interval)}window.addEventListener("click",stop),window.addEventListener("touchend",stop);function getQueryParameter(a){var d=window.location.href;a=a.replace(/[\[\]]/g,"\\$&");var b=new RegExp("[?&]"+a+"(=([^&#]*)|&|#|$)"),c=b.exec(d);return c?c[2]?decodeURIComponent(c[2].replace(/\+/g," ")):"":null}var ZOOM=+getQueryParameter("zoom")||1,WIDTH=(canvas.width=window.innerWidth)/ZOOM,HEIGHT=(canvas.height=window.innerHeight)/ZOOM;ctx.scale(ZOOM,ZOOM);var STEP=5,NOISE_AMT=0.3,SPLIT_RATE=0.035,SPLIT_CHANCE=1-Math.pow(1-SPLIT_RATE,STEP),SPLIT_SPREAD=0.5,nodes=[],activeNodes=[];function addNode(a,b,c,d,e){var f=5<arguments.length&&arguments[5]!==void 0?arguments[5]:null,g={x:a,y:b,vx:c,vy:d,parent:f};nodes.push(g),e.push(g);var h=Math.floor(a/CELL_SIZE)+","+Math.floor(b/CELL_SIZE),i=cells[h];i?i.push(g):cells[h]=[g]}function randNoise(a){return 2*(Math.random()*a)-a}function addChildNode(a,b,c,d){var e=a.vx+b,f=a.vy+c,g=1/Math.hypot(e,f);e*=g,f*=g,addNode(a.x+e*STEP,a.y+f*STEP,e,f,d,a)}var STOP_DIST_THRESHOLD=30,COS_THRESHOLD=0.6,SPLIT_DIST_THRESHOLD=25,COUNT_THRESHOLD=30/STEP;function getProps(a){var b=0;return forEachNearbyNode(a,function(c){if(c===a)return!1;var d=c.x-a.x,e=c.y-a.y,f=d*d+e*e;if(f<STOP_DIST_THRESHOLD*STOP_DIST_THRESHOLD){var g=d*a.vx+e*a.vy;if(0<g&&g*g/f>COS_THRESHOLD*COS_THRESHOLD)return{stop:!0,canSplit:!1};f<SPLIT_DIST_THRESHOLD*SPLIT_DIST_THRESHOLD&&++b}})||{stop:!1,canSplit:b<COUNT_THRESHOLD}}var CELL_SIZE=2*Math.max(STOP_DIST_THRESHOLD,SPLIT_DIST_THRESHOLD),cells={};function forEachNearbyNode(a,b){function c(f,g){var h=cells[f+","+g];if(h){var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var j,i=h[Symbol.iterator]();!(_iteratorNormalCompletion=(j=i.next()).done);_iteratorNormalCompletion=!0){var k=j.value,l=b(k);if(l)return l}}catch(m){_didIteratorError=!0,_iteratorError=m}finally{try{!_iteratorNormalCompletion&&i.return&&i.return()}finally{if(_didIteratorError)throw _iteratorError}}}return!1}var d=Math.round(a.x/CELL_SIZE),e=Math.round(a.y/CELL_SIZE);return c(d,e)||c(d-1,e)||c(d,e-1)||c(d-1,e-1)}addNode(WIDTH/2,HEIGHT/2,0,-1,activeNodes),ctx.fillStyle="black",ctx.fillRect(0,0,WIDTH,HEIGHT);function frame(){var a=performance.now();ctx.fillStyle=ctx.strokeStyle="white";var _iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var e,f,d=activeNodes[Symbol.iterator]();!(_iteratorNormalCompletion2=(e=d.next()).done);_iteratorNormalCompletion2=!0)f=e.value,f.parent&&drawLine(f.x,f.y,f.parent.x,f.parent.y)}catch(q){_didIteratorError2=!0,_iteratorError2=q}finally{try{!_iteratorNormalCompletion2&&d.return&&d.return()}finally{if(_didIteratorError2)throw _iteratorError2}}var b=[],_iteratorNormalCompletion3=!0,_didIteratorError3=!1,_iteratorError3=void 0;try{for(var h,g=activeNodes[Symbol.iterator]();!(_iteratorNormalCompletion3=(h=g.next()).done);_iteratorNormalCompletion3=!0){var i=h.value,j=getProps(i);if(!j.stop){var q=randNoise(NOISE_AMT),s=randNoise(NOISE_AMT);if(j.canSplit&&Math.random()<SPLIT_CHANCE){var t=i.vy*SPLIT_SPREAD,u=-i.vx*SPLIT_SPREAD;0.5>Math.random()&&(t=-t,u=-u),addChildNode(i,q+t,s+u,b),addChildNode(i,q-t,s-u,b)}else addChildNode(i,q,s,b)}}}catch(q){_didIteratorError3=!0,_iteratorError3=q}finally{try{!_iteratorNormalCompletion3&&g.return&&g.return()}finally{if(_didIteratorError3)throw _iteratorError3}}activeNodes=b;var c=performance.now();console.log("frame() took "+(c-a).toFixed(1)+" ms")}function fillCircle(a,b,c){ctx.beginPath(),ctx.arc(a,b,c,0,2*Math.PI),ctx.closePath(),ctx.fill()}function drawLine(a,b,c,d){ctx.beginPath(),ctx.moveTo(a,b),ctx.lineTo(c,d),ctx.stroke()}window.interval=setInterval(frame,10*STEP/(+getQueryParameter("speed")||1));